---
sidebar: sidebar 
permalink: create-replication.html 
keywords: replication, replicate, data protection, disaster recovery, data loss 
summary: 為適用於 ONTAP 檔案系統的 FSX 建立複寫關係、以避免在發生無法預見的災難時遺失資料。 
---
= 在 NetApp Workload Factory 中將資料複製到 FSx for ONTAP
:allow-uri-read: 
:icons: font
:imagesdir: ./media/


[role="lead"]
在 NetApp Workload Factory 中為 FSx for ONTAP 檔案系統建立複寫關係，以避免在發生意外災難時資料遺失。您可以在兩個 FSx for ONTAP 檔案系統之間複寫資料，也可以在內部部署 ONTAP 系統和 FSx for ONTAP 檔案系統之間複寫資料。

對於儲存 VM 遷移，您必須在建立複寫關係後立即完成切換作業。



== 關於這項工作

如果您的地區發生災難，複寫功能可以保護您的資料；它還可以用於移轉目的。

目標檔案系統中的複寫磁碟區為資料保護（ DP ）磁碟區，並遵循命名格式： `{OriginalVolumeName}_copy`。

如果複製的來源磁碟區包含不可變檔案，則目標磁碟區和檔案系統將保持鎖定狀態，直到來源磁碟區的保留期結束。當您link:create-volume.html["創建卷"] FSx for ONTAP 檔案系統時，不可變檔案功能可用。

[NOTE]
====
* 使用 iSCSI 或 NVMe 通訊協定的區塊磁碟區不支援複寫。
* 您可以複寫一個來源（讀取 / 寫入）磁碟區或一個資料保護（ DP ）磁碟區。支援串聯複寫，但不支援第三個躍點。深入瞭解 link:https://review.docs.netapp.com/us-en/workload-fsx-ontap_cascade-replication/cascade-replication.html["串聯複寫"^]。


====


=== 遷移使用案例

選擇遷移使用案例時，您可以選擇複製單一 storage VM 的 storage VM 資料和組態設定。同時移轉資料和組態設定時、請確保磁碟區的最後一次複寫已在過去 24 小時內完成。必須選取同一個儲存 VM 中的所有磁碟區、才能使用此功能。所有磁碟區的分層原則預設為來源磁碟區的分層原則、建議用於移轉使用案例。

Workload Factory 支援以下儲存系統之間的移轉複寫。

* 內部部署 ONTAP 系統和 FSx for ONTAP 檔案系統
* Cloud Volumes ONTAP 和 FSx for ONTAP 檔案系統
* FSx for ONTAP 和 FSx for ONTAP 檔案系統
+
** 第一代到第一代
** 第一代到第二代
** 第二代至第二代




若要遷移儲存 VM 資料和組態設定，您必須完成兩項作業。

. <<建立複寫關係,建立複寫關係>>，選擇 *Migration* 作為使用案例，然後選擇 *Replicate storage VM configuration*。
. <<Cut over replication,切換複寫>> 將資料和組態設定從來源檔案系統永久遷移到目標 FSx for ONTAP 檔案系統。




== 建立複寫關係

在兩個 FSx for ONTAP 檔案系統之間、或在內部部署 ONTAP 系統和 FSx for ONTAP 檔案系統之間複寫資料。

.開始之前
開始之前、請先檢閱這些需求。

* 您必須擁有一個 FSx for ONTAP 檔案系統，才能在複寫關係中用作目標。
* 您用於複寫關係的 FSx for ONTAP 檔案系統必須具備相關聯的連結。link:https://docs.netapp.com/us-en/workload-fsx-ontap/create-link.html["了解如何關聯現有連結或建立並關聯新連結"]。在您關聯連結後，請返回此操作。
* 若要從內部部署 ONTAP 系統複寫到 FSx for ONTAP 檔案系統，請確保您已探索內部部署 ONTAP 系統。
* 對於處於可用、已建立或配置錯誤以外狀態的磁碟區，以及 ONTAP 版本不相容時，不支援複寫。
* 對於遷移使用案例，請確保在使用儲存 VM 資料和組態設定建立複寫關係之前，磁碟區的最後一次複寫已在過去 24 小時內完成。


.步驟
. 使用其中一項登link:https://docs.netapp.com/us-en/workload-setup-admin/console-experiences.html["主控台體驗"^]入。
. 選擇選單 image:workloads-menu-icon.png["漢堡選單圖示用於導航至儲存、EDA、AI、資料庫、VMware 和管理等工作負載。"] 然後選擇“儲存”。
. 從儲存選單中，選擇 *FSx for ONTAP*。
. 從 *FSx for ONTAP* 中、選取包含要複寫之磁碟區的檔案系統。
. 可複寫檔案系統中的所有磁碟區，或複寫選取的磁碟區。
+
** 若要複寫檔案系統中的所有磁碟區：從檔案系統總覽選取 * 複寫資料 * 。
** 若要複寫選取的磁碟區：從檔案系統總覽中選取 * Volumes （磁碟區） * 標籤。
+
在 Volumes （卷）表中，選擇一個或多個卷，然後選擇 *Replicate data* 。



. 在「複寫資料」頁面的「複寫目標」下，提供下列項目：
+
.. *用例*：選擇以下其中一個用例進行複製。根據所選的用例，Workload Factory 會根據最佳實踐在表單中填入建議值。您可以接受建議的數值，也可以在填寫表格時進行變更。
+
*** 移轉：將資料傳輸至 ONTAP 檔案系統的目標 FSX
+
*複製儲存 VM 組態*：您可以選擇複製單一儲存 VM 的資料和組態設定。同時移轉資料和組態設定時、請確保磁碟區的最後一次複寫已在過去 24 小時內完成。必須選取同一個儲存 VM 中的所有磁碟區、才能使用此功能。所有磁碟區的分層原則預設為來源磁碟區的分層原則、建議用於移轉使用案例。

*** 熱災難恢復：確保關鍵工作負載的高可用度和快速災難恢復
*** 冷災難恢復或歸檔災難恢復：
+
**** 冷災難恢復：使用較長的恢復時間目標（ RTO ）和恢復點物件（ RPO ）來降低成本
**** 歸檔：複寫資料以供長期儲存和法規遵循


*** 其他
+
此外，使用案例選項會決定複寫原則或 SnapMirror 原則（ ONTAP ）。用於描述複寫原則的術語來自link:https://docs.netapp.com/us-en/ontap/data-protection/default-protection-policies-concept.html["部分9文件ONTAP"^]。

+
**** 對於移轉和其他作業，複寫原則稱為 _MirrorAllSnapshots_ 。_MirrorAllSnapshots_ 是用於鏡射所有快照和最新作用中檔案系統的非同步原則。
**** 對於熱災難恢復，冷災難恢復或歸檔災難恢復，複製策略稱爲 _MirrorAndVault_ 。_MirrorAndVault_ 是一種非同步和資料保險箱原則，可用於鏡射最新的作用中檔案系統，以及每日和每週快照。
+
在所有使用案例中，如果您啟用快照以進行長期保留，則預設複寫原則為 _MirrorAndVault_ 。





.. * 適用於 ONTAP 檔案系統 * 的 FSX ：針對適用於 ONTAP 檔案系統的目標 FSX 、選取 ONTAP 檔案系統名稱的認證、區域和 FSX 。
.. * 儲存 VM 名稱 * ：從下拉式功能表中選取儲存 VM 。您選擇的儲存虛擬機器是此複製關係中所有選定磁碟區的目標。
.. *Volume name* ：目標 Volume 名稱會自動以下列格式產生 `{OriginalVolumeName}_copy`。您可以使用自動產生的 Volume 名稱或輸入其他 Volume 名稱。
.. * 分層原則 * ：選取儲存在目標 Volume 中的資料分層原則。分層原則預設為您所選使用案例的建議分層原則。
+
使用 Workload Factory 控制台建立磁碟區時，_平衡（自動）_ 是預設分層策略。有關卷分層策略的更多信息，請參閱link:https://docs.aws.amazon.com/fsx/latest/ONTAPGuide/volume-storage-capacity.html#data-tiering-policy["Volume 儲存容量"^]在 AWS FSx for NetApp ONTAP文件中。請注意，工作負載工廠在工作負載工廠控制台中使用基於用例的名稱來制定分層策略，並在括號中包含 FSx for ONTAP分層策略名稱。

+
如果您選擇了遷移案例，Workload Factory 會自動選擇將來源磁碟區的分層策略複製到目標磁碟區。您可以取消選擇複製分層策略並選擇適用於選擇進行複製的磁碟區的分層策略。

.. * 最大傳輸速率 * ：選取 * 受限 * 、然後以 MB/s 為單位輸入最大傳輸限制或者、選取 * 無限 * 。
+
如果沒有限制、網路和應用程式的效能可能會下降。或者、我們建議為 ONTAP 檔案系統的關鍵工作負載（例如主要用於災難恢復的工作負載）提供不限傳輸率的 FSX 。



. 在複寫設定下、提供下列項目：
+
.. * 複寫間隔 * ：選取快照從來源磁碟區傳輸到目標磁碟區的頻率。
.. * 長期保留 * ：可選擇啟用快照以進行長期保留。長期保留功能可讓業務服務持續運作、即使整個站台發生故障、也能支援應用程式使用次要複本以透明方式容錯移轉。
+
未啟用長期保留的複製將使用 _MirrorAllSnapshots_ 策略。啟用長期保留會將 _MirrorAndVault_ 策略指派給複製。

+
如果您啟用長期保留、請選取現有原則或建立新原則、以定義要複寫的快照和要保留的數量。

+

NOTE: 長期保留需要相符的來源和目標標籤。如有需要，工作負載工廠可能會為您建立遺失的標籤。

+
*** * 選擇現有的原則 * ：從下拉式功能表中選取現有的原則。
*** *建立新策略*：輸入*策略名稱*。


.. *不可變快照*：可選。選取 * 啟用不可變快照 * ，以防止在保留期間刪除在此原則中拍攝的快照。
+
*** 將 * 保留期間 * 設定為小時數，天數，月數或年數。
*** * Snapshot Policies * ：在表格中、選取快照原則頻率和要保留的複本數量。您可以選取多個快照原則。


.. *S3 存取點*：可選地，透過 AWS S3 API 連接 S3 存取點，以存取駐留在 NFS 或 SMB/CIFS 磁碟區上的 FSx for ONTAP檔案系統資料。僅支援文件存取類型。提供以下詳細資訊：
+
*** *S3接入點名稱*：輸入S3接入點的名稱。
*** *使用者*：選擇有權存取該磁碟區的現有使用者或建立新使用者。
*** *使用者類型*：選擇*UNIX*或*Windows*作為使用者類型。
*** *網路組態*：選擇 *Internet* 或 *Virtual private cloud (VPC)*。您選擇的網路類型決定了存取點是可從網際網路存取，還是僅限於特定的 VPC。
*** *啟用元資料*：啟用元資料會建立一個 S3 表，其中包含 S3 存取點可存取的所有物件，您可以將其用於稽核、治理、自動化、分析和最佳化。啟用元資料會產生額外的 AWS 費用。請參閱 link:https://aws.amazon.com/s3/pricing/["Amazon S3 定價文件"^] 以了解更多資訊。


.. *S3 存取點標籤*：您可以選擇新增最多 50 個標籤。




. 選擇* Create *（建立*）。


.結果
複寫關係會出現在 ONTAP 檔案系統的目標 FSX 的 * 複寫關係 * 索引標籤中。

如果您為了遷移目的建立了複製關係，則必須切換所有磁碟區及其關聯的儲存 VM，才能完成將儲存 VM 資料和組態設定遷移到目標 FSx for ONTAP 檔案系統。



== 切換複寫以適應移轉使用案例

為遷移用例建立複製關係後，您必須執行切換複製，才能將儲存 VM 資料和組態設定遷移到目標 FSx for ONTAP 檔案系統。切換複製會將資料和儲存 VM 組態設定從來源檔案系統永久遷移到目標 FSx for ONTAP 檔案系統。切換期間，資料將進行最後一次複製。切換完成後，系統將刪除來源磁碟區。此操作無法復原。

.開始之前
開始之前、請先檢閱這些需求。

* 在切換複寫之前，請停止所有用戶端對儲存 VM 的存取。
* 在切換複寫之前，請確保所有來源磁碟區均未承載任何資料。
* 在切換複製之前、請確保來源磁碟區和目標磁碟區之間的資料已同步。
* 您用於複寫關係的 FSx for ONTAP 檔案系統必須具備相關聯的連結。link:https://docs.netapp.com/us-en/workload-fsx-ontap/create-link.html["了解如何關聯現有連結或建立並關聯新連結"]。在您關聯連結後，請返回此操作。


.步驟
. 使用其中一項登link:https://docs.netapp.com/us-en/workload-setup-admin/console-experiences.html["主控台體驗"^]入。
. 選擇選單 image:workloads-menu-icon.png["漢堡選單圖示用於導航至儲存、EDA、AI、資料庫、VMware 和管理等工作負載。"] 然後選擇“儲存”。
. 從儲存選單中，選擇 *FSx for ONTAP*。
. 從 *FSx for ONTAP* 中、選取包含要複寫之磁碟區的檔案系統。
. 選擇 *Replication relationships* 標籤。
. 在複製關係表中、選取要切換的複製關係、然後選取 *Cut over replication* 。
. 查看「切換複製」對話方塊中的資訊，然後輸入 _cut over_ 進行確認。


. 選擇 *Cut over* 。


.結果
切換完成後，來源磁碟區將被刪除，目標磁碟區將變為讀 / 寫狀態。您可以在切換完成後link:change-tiering-policy.html["修改分層原則"]目標磁碟區。
